<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script></head>
<body>
  <span id="status">network status</span>
  <button id="openModal">設定</button>
  <select name="channel" id="channel">
    <option value="main">雑談</option>
    <option value="battle">バトスタ</option>
    <option value="dual">DUAL</option>
  </select>
  <label for="verify">スピ限</label>
  <input type="checkbox" id="verify" name="verify">
  <br>
  <label for="message"></label>
  <textarea id="message" rows="6" required></textarea>
  <br>
  <button onclick="sendMessageByUser()">送信</button>
  <br>
  <div id="modalOverlay">
    <div id="modal">
      <button id="closeModal">閉じる</button>
      <h3>設定</h3>
      <label for="name">名前</label>
      <input type="text" id="name" value="" maxlength="25" required>　
      <label for="seed">シード</label>
      <input type="text" id="seed" value="" required>
      <br>
      <label for="darkmode">ダークモード:</label>
      <input type="checkbox" id="darkmode" name="darkmode">
      <br>
      <label for="font">フォント:</label>
      <select name="font" id="font-select">
        <option value="">default</option>
        <option value="Monospace">Monospace</option>
        <option value="Arial">Arial</option>
        <option value="Helvetica">Helvetica</option>
        <option value="Times New Roman">Times New Roman</option>
        <option value="Verdana">Verdana</option>
      </select>
      <br>
      <label for="font-size">フォントサイズ:</label>
      <input name="font-size" type="range" min=6 max=26 id="font-size">
      <output id="font-size-val"></output>
    </div>
  </div>
  <div id="container">
    <div id="loading">loading...</div>
  </div>
<style>
* {
  margin: 0;
  padding: 0;
}

html {
  scroll-behavior: smooth;
}
  
body {
  width: 100vw;
  min-width: 100vw;
  max-width: 100vw;
}

select {
  border-radius: 0;
}
  
textarea {
  margin: 10px;
}

a {
  color: black;
}
  
#status {
  position: absolute;
  top: 10px;
  right: 10px;
}

.online {
  color: black;
  background-color: greenyellow;
  box-shadow: 0 0 7px limegreen;
}

.offline {
  color: white;
  background-color: red;
  box-shadow: 0 0 7px orangered;
}

button {
  border: 0;
  border-radius: 0;
  background-color: rgba(225, 225, 225, 0.1);
  text-align: left;
}

#modalOverlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
}

#modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 80vw;
  padding: 20px;
  background-color: white;
  display: none;
  border-radius: 5px;
}

#closeModal {
  position: absolute;
  top: 10px;
  right: 10px;
}

input {
  height: 1em;
  border-radius: 0;
}

#container {
  display: flex;
	flex-direction: row;
	flex-wrap: wrap;
}

.message {
  width: 100%;
}

.message-author {
  width: 100%;
  padding: 6px;
}
.message-content {
  width: 100%;
  padding: 12px;
}

.tab {
  width: 50%;
}
</style>
<script>
// オートリンク
function autoLink(str) {
  var urlRegex = /(https?:\/\/[a-zA-Z0-9.\-_@:/~?%&;=+#',()*!]+)/g;
  return text.replace(urlRegex, function(url) {
    return '<a href="' + url + '">' + url + '</a>';
  });
}

// ライトモード化
function toLightmode() {
  $('body').css('background-color', 'white');
  $('#modal').css('background-color', 'white');
  $('textarea').css('background-color', 'white');
  $('input').css('background-color', 'white');
  $('body').css('color', 'black');
  $('button').css('color', 'black');
  $('textarea').css('color', 'black');
  $('input').css('color', 'black');
  $('a').css('color', 'black');
  $('textarea').css('border', '1px solid black');
  $('input').css('border', '1px solid black');
}
  
// ダークモード化
function toDarkmode() {
  $('body').css('background-color', 'black');
  $('#modal').css('background-color', 'black');
  $('textarea').css('background-color', 'black');
  $('input').css('background-color', 'black');
  $('body').css('color', 'white');
  $('button').css('color', 'white');
  $('textarea').css('color', 'white');
  $('input').css('color', 'white');
  $('a').css('color', 'white');
  $('textarea').css('border', '1px solid white');
  $('input').css('border', '1px solid white');
}
  
// メッセージ送信
function sendMessage(name, seed, channel, message) {
  if (name=='' || seed=='' || channel=='' || message=='') {
    console.warn('Invalid argument(s).')
  } else {
    message = btoa(unescape(encodeURIComponent(message)));
    $.ajax({
      type: 'GET',
      url: '/bbs/result',
      data: {
        'name': name,
        'seed': seed,
        'message': message,
        'channel': channel
      }
    });
    console.log(message, btoa(message))
  }
}

// メッセージ送信
function sendMessageByUser() {
  var name = $('#name').val();
  var seed = $('#seed').val();
  var message = $('#message').val();
  var channel = $('#channel').val();
  sendMessage(name, seed, channel, message);
  $('#message').val("");
}

// メッセージ取得
function getMessage(channel, filter) {
  fetch(`/api?channel=${channel}&verify=${filter}&t=0`)
    .then(response => response.text())
    .then(xml => {
      const headerRegex = /<h3>(.*?)<\/h3>/;
      const rowRegex = /<tr>.*?<td>(.*?)<\/td>.*?<td><font color="(.*?)">(.*?)<\/font><font color="(.*?)">@(\w+)<\/font><font color="magenta">(.*?)<\/font><\/td>.*?<td>(.*?)<\/td>.*?<\/tr>/gs;
      const headerMatch = headerRegex.exec(xml);
      const header = headerMatch ? headerMatch[1] : null;
      const items = [];
      let match;
      while ((match = rowRegex.exec(xml)) !== null) {
        const item = {
          number: match[1],
          name: match[3],
          color: match[2],
          id: match[5],
          message: match[7]
        };
        if (match[6]) {
            item.description = match[6];
        } else {
          item.description = undefined;
        }
        items.push(item);
      }
      return {
        header: header,
        items: items
      };
    })
  .catch(error => console.error('mmg.get.err:', error));
}

// メッセージレンダリング
function createMessages(channel, filter) {
  var messages = getMessage(channel, filter);
  var html = "";
  messages.forEach(function(message) {
    var desc = message.description === undefined ? "" | message.description
    html += `<div class="message"><div class="message-author"><span style="font-weight: bold; margin-right: 1em;">${message.number}</span> <span style="color: ${message.color};">${message.name}</span><span style="color: ${message.defaultColor};">@${message.id}</span> <span style="color: magenta;">${desc}</span></div><div class="message-content">${message.message}</div></div>`;
  });
  return html;
}

// メッセージ読み込み
function loadMessage() {
  var container = document.getElementById("container");
  if (document.getElementById("channel").value == "main" || document.getElementById("channel").value == "battle") {
    var msgs = createMessages(document.getElementById("channel").value, document.getElementById("verify").checked);
    container.innerHTML(msg);
  } else if (document.getElementById("channel").value == "dual") {
    var mainMsgs = createMessages("main", document.getElementById("verify").checked);
    var battleMsgs = createMessages("battle", document.getElementById("verify").checked);
    var html = `<div class="tab">${mainMsgs}</div><div class="tab">${battleMsgs}</div>`;
    container.innerHTML(html);
  }
}

// ネットワークコネクション検知
function updateConnectionStatus() {
  var status = $('#status');
  if (navigator.onLine) {
    status.removeClass('offline').addClass('online');
    status.text('online');
  } else {
    status.removeClass('online').addClass('offline');
    status.text('offline');
  }
}

$(document).ready(function() {
  updateConnectionStatus();
  window.addEventListener('online', updateConnectionStatus);
  window.addEventListener('offline', updateConnectionStatus);

  loadMessage();
  
  var selectedChannel = localStorage.getItem('channel');
  if (selectedChannel) {
    $('#channel').val(selectedChannel);
  }
  
  $('#channel').change(function() {
    var newSelectedChannel = $(this).val();
    localStorage.setItem('channel', newSelectedChannel);
    loadMessage();
  });

  var isVerified = localStorage.getItem('verify') === 'true';
  $('#verify').prop('checked', isVerified);

  $('#verify').change(function() {
    var isVerified = $(this).prop('checked');
    localStorage.setItem('verify', isVerified.toString());
    loadMessage();
  });

  var storedName = localStorage.getItem('name');
  var storedSeed = localStorage.getItem('seed');

  if (storedName) {
    $('#name').val(storedName);
  }
  if (storedSeed) {
    $('#seed').val(storedSeed);
  }
  
  $('#name').on('input', function() {
    var newName = $(this).val();
    localStorage.setItem('name', newName);
  });
  $('#seed').on('input', function() {
    var newSeed = $(this).val();
    localStorage.setItem('seed', newSeed);
  });

    $('#openModal').click(function() {
    $('#modalOverlay').fadeIn(300);
    $('#modal').fadeIn(300);
  });

  $('#closeModal').click(function() {
    $('#modalOverlay').fadeOut(300);
    $('#modal').fadeOut(300);
  });
  
  var selectedFont = localStorage.getItem('font');
  if (selectedFont) {
    $('#font-select').val(selectedFont);
    $('body').css('font-family', selectedFont);
  }
  
  $('#font-select').change(function() {
    var newSelectedFont = $(this).val();
    localStorage.setItem('font', newSelectedFont);
    $('body').css('font-family', newSelectedFont);
  });
  
  var selectedFontSize = localStorage.getItem('font-size');
  if (selectedFontSize) {
    $('#font-size').val(selectedFontSize);
    $('body').css('font-size', `${selectedFontSize}px`);
    $('#font-size-val').text(`${selectedFontSize}px`);
  }
  
  $('#font-size').change(function() {
    var newFontSize = $(this).val();
    localStorage.setItem('font-size', newFontSize)
    $('body').css('font-size', `${newFontSize}px`);
    $('#font-size-val').text(`${newFontSize}px`);
  });

  var isDarkmode = localStorage.getItem('darkmode') === 'true';
  $('#darkmode').prop('checked', isDarkmode);

  $('#darkmode').change(function() {
    var isDarkmode = $(this).prop('checked');
    localStorage.setItem('darkmode', isDarkmode.toString());
    if (isDarkmode) { toDarkmode(); } else { toLightmode(); }
  });
  if (isDarkmode) { toDarkmode(); } else { toLightmode(); }

  loadMessage();
  setInterval(function() { loadMessage(); }, 5000);
});
</script>
</body>
</html>
